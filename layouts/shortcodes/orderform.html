<div class="row">
  <!-- Left column -->
  <div class="col-lg-6 col-12">
    <!-- Billing Email -->
    <div class="mb-3">
      <label for="email" class="form-label">Billing email</label>
      <input class="form-control" type="email" id="email" />
      <p class="text-danger" id="email-error" style="display: none">
        Please enter valid e-mail
      </p>
    </div>

    <!-- Name for License -->
    <div class="mb-3">
      <label for="name" class="form-label">Name for License</label>
      <input
        class="form-control"
        type="text"
        id="name"
        placeholder="eg. your full name or your company name"
      />
    </div>

    <!-- Number of Users -->
    <div class="mb-3">
      <label for="users" class="form-label">Number of users</label>
      <input class="form-control" type="number" placeholder="1" id="users" />
    </div>

    <!-- Subscription -->
    <div class="mb-3">
      <label for="subscription" class="form-label">Subscription</label>
      <select class="form-select" id="subscription">
        <option value="yearly" data-product="premium">
          Yearly - $120/year
        </option>
        <option value="monthly" data-product="premium">
          Monthly - $12/month
        </option>
        <option value="yearly" data-product="team-premium">
          Yearly - $150/year/user
        </option>
      </select>
    </div>

    <p>
      <a
        target="_blank"
        class="btn btn-primary btn-lg"
        onclick="sendForm()"
      >
        Continue
      </a>
    </p>
  </div>

  <!-- Right column (hidden on tablets and smaller devices, margin left) -->
  <div class="col-lg-5 d-none d-lg-block ms-3">
    <h4>Features in this package</h4>
    <ul id="features">
      <li data-product="premium">All features from Community edition</li>
      <li data-product="premium">DbGate desktop application (Windows, Linux, Mac)</li>
      <li data-product="premium">Query designer</li>
      <li data-product="premium">Compare database models</li>
      <li data-product="premium">Table perspectives</li>
      <li data-product="premium">Access to cloud databases - Amazon RDS, Redshift, Azore CosmosDB</li>
      <li data-product="premium">E-mail support</li>

      <li data-product="team-premium">All features from Community edition</li>
      <li data-product="team-premium">DbGate desktop application (Windows, Linux, Mac)</li>
      <li data-product="team-premium">DbGate web application (Docker or NPM distribution)</li>
      <li data-product="team-premium">From 2 users</li>
      <li data-product="team-premium">Query designer</li>
      <li data-product="team-premium">Compare database models</li>
      <li data-product="team-premium">Table perspectives</li>
      <li data-product="team-premium">Administration - users, connections, roles</li>
      <li data-product="team-premium">Access to cloud databases - Amazon RDS, Redshift, Azure CosmosDB</li>
      <li data-product="team-premium">E-mail support</li>
    </ul>
  </div>
</div>

<script>
  function getProduct() {
    return document.location.pathname
      .split("/")
      .filter((x) => x)
      .slice(-1)?.[0];
  }

  function initialize() {
    const product = getProduct();

    // Filter subscription options based on product
    const subscriptionElement = document.getElementById("subscription");
    const options = subscriptionElement.options;
    for (let i = options.length - 1; i >= 0; i--) {
      if (options[i].getAttribute("data-product") !== product) {
        subscriptionElement.remove(i);
      }
    }

    // Filter feature list based on product
    const featuresElement = document.getElementById("features");
    for (let i = 0; i < featuresElement.children.length; i++) {
      if (featuresElement.children[i].getAttribute("data-product") !== product) {
        featuresElement.children[i].style.display = "none";
      }
    }

    // Default users to 2 for team-premium
    if (product === "team-premium") {
      document.getElementById("users").value = 2;
    }
  }

  async function sendForm() {
    const emailInput = document.getElementById("email");
    const emailError = document.getElementById("email-error");
    const email = emailInput.value;

    // Simple e-mail pattern
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailPattern.test(email)) {
      emailInput.classList.add("is-invalid"); // You could also handle is-invalid via .form-control
      emailError.style.display = "block";
      return;
    } else {
      emailInput.classList.remove("is-invalid");
      emailError.style.display = "none";
    }

    const name = document.getElementById("name").value;
    const users = document.getElementById("users").value;
    const subscription = document.getElementById("subscription").value;
    const product = getProduct();

    const data = {
      email: email,
      name: name,
      users: users,
      subscription: subscription,
      product
    };

    try {
      const response = await fetch(
        // "https://auth-proxy.dbgate.udolni.net/new-subscription",
        "https://auth.dbgate.eu/new-subscription",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        }
      );
      const json = await response.json();
      if (json.url) {
        window.location.href = json.url;
        return;
      }
      alert("An error occurred while creating the subscription.");
    } catch (error) {
      console.error("Error:", error);
      alert("An error occurred while sending data.");
    }
  }

  document.addEventListener("DOMContentLoaded", initialize);
</script>
